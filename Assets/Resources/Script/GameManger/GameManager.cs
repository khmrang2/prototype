using System.Collections;
using System.Collections.Generic;
using Unity.VisualScripting;
using UnityEngine;

// 占쏙옙占쏙옙占쏙옙 占쏙옙 占쏙옙황占쏙옙 占쏙옙占쏙옙占싹곤옙 占쏙옙占쏙옙占싹깍옙 占쏙옙占쌔쇽옙
// 占쌓놂옙 占싱몌옙 占쏙옙占쏙옙 enum.
public enum GameTurn
{
    // 13일 (수) 멘토님 컨펌
    // 태연
    DropBallState,          // 플레이어의 턴으로 공을 떨어뜨리는 상태 - 태연

    // 정훈님 
    PlayerAtkState,         // 떨어뜨린 공으로 적을 공격하는 상태

    // 시우님
    EnemyBehaviorState,     // 적의 턴으로 적이 행동(공격 or 움직임)하는 상태
    SpawnEnemyState,        // 적이 생성되는 상태

    // 현민
    EndChkState,            // 스테이지가 끝났는지(모든 적이 죽었는지) 체크하는 상태
    ChooseBuffState,        // 플레이어의 턴으로 버프를 선택하는 상태->>
}
struct buffState
{
    int numberOfBalls;
    //int spawnOffset;
    int damageOfBall;
};
public class GameManager : MonoBehaviour
{
    public static GameManager Instance { get; private set; }
    public GameObject prefPlayerAtkProjrctile;
    private GameObject plAtkObj;
    public Transform playerTransform;  // 플레이어의 Transform
    public EnemyListManager enemyListManager;  // EnemyListManager 참조
    // 현민 - 
    // 게임할 state들을 불러옴.
    // 플레이어가 기본적으로 불러오는 state. 
    // 버프를 받아서 갱신될 cur_state.
    [SerializeField]
    public BuffManager buffManager;
    
    BaseState buffState = null;
    BaseState defaultState = null;
    BaseState playerState = null;

    public int damageSum = 0;
    public GameTurn currentTurn = GameTurn.DropBallState;
    public PinManager pinManager;
    public InteractionArea interactionArea;

    // 각 상태의 동작이 시작되었는지 여부를 체크하는 플래그
    private bool stateStarted = false;

    void Start()
    {
        buffState = new BaseState();
        defaultState = new BaseState();
        playerState = new BaseState();
        enemyListManager.SpawnInitialEnemies();
    }
    /// <summary>
    /// stateStarted로 스핀락을 구현하여
    /// 턴을 강제함.
    /// </summary>

    void Update()
    {
        switch (currentTurn)
        {
            case GameTurn.DropBallState:
                if (!stateStarted)
                {
                    Debug.Log("Dropping ball...");
                    stateStarted = true;
                }
                if (ballHasDropped())
                {
                    stateStarted = false;
                    currentTurn = GameTurn.PlayerAtkState;
                }
                break;

            case GameTurn.PlayerAtkState:
                if (!stateStarted)
                {
                    plAtkObj = Instantiate(prefPlayerAtkProjrctile);
                    plAtkObj.transform.position = new Vector3(-2.4f, 4.85f, 0);
                    Debug.Log("Player attacking...");
                    stateStarted = true;
                }
                if (enemyAtkEnded())
                {
                    stateStarted = false;
                    currentTurn = GameTurn.EnemyBehaviorState;
                }
                break;

            case GameTurn.EnemyBehaviorState:
                if (!stateStarted)
                {
                    Debug.Log("Enemies moving...");
                    // 적 이동을 시작 (enemyListManager.MoveEnemies()가 내부적으로 이동을 처리하고,
                    // AllEnemiesMoved()가 이동 완료를 판단한다고 가정)
                    enemyListManager.MoveEnemies();
                    stateStarted = true;
                }
                if (enemyListManager.AllEnemiesMoved())
                {
                    enemyListManager.SpawnEnemyPerTurn();
                    stateStarted = false;
                    currentTurn = GameTurn.ChooseBuffState;
                }
                break;

            case GameTurn.ChooseBuffState:
                if (!stateStarted)
                {
                    Debug.Log("Choosing a buff...");
                    buffManager.ShowBuffSelection();
                    stateStarted = true;
                }
                if (buffManager.IsBuffSelected())
                {
                    updateBuffState();
                    Debug.Log("Buff updated.");
                    buffState.printAllStates();
                    stateStarted = false;
                    currentTurn = GameTurn.EndChkState;
                }
                break;

            case GameTurn.EndChkState:
                if (!stateStarted)
                {
                    Debug.Log("Checking end conditions...");
                    damageSum = 0;
                    interactionArea.init_ball();
                    stateStarted = true;
                }
                if (chkStageEnded())
                {
                    stateStarted = false;
                    currentTurn = GameTurn.DropBallState;
                }
                break;
        }
    }
    public bool ballHasDropped()
    {
        if (interactionArea.get_ball_num() == 0 && GameObject.FindWithTag("Ball") == null)
        {
            damageSum = pinManager.hit_cnt_sum();
            Debug.Log("Total hit count: " + damageSum);
            pinManager.init_pins_hit_cnt();
            return true;
        }
        return false;
    }

    private bool enemyAtkEnded()
    {
        return plAtkObj == null;
    }

    private bool chkStageEnded()
    {
        // 스테이지 종료 조건 체크 로직 (필요에 따라 수정)
        return true;
    }

    public void updateBuffState()
    {
        this.buffState = buffManager.getBuffSumState();
    }

    // 투사체가 제거될 때 호출되어 상태를 업데이트
    public void NotifyProjectileDestroyed()
    {
        plAtkObj = null;
    }
}

/**
    private IEnumerator DropBallTurn()
    {
        Debug.Log("Dropping ball...");
        yield return new WaitUntil(() => ballHasDropped());
    }

    private IEnumerator PlayerAtkTurn()
    {
        //플레이어 공격 투사체 생성
        //투사체는 스스로 나아가며 적과 접촉하거나 지정한 범위 밖으로 나가면 스스로 제거
        plAtkObj = Instantiate(prefPlayerAtkProjrctile);
        plAtkObj.transform.position = new Vector3(-2.4f, 4.85f, 0);
        Debug.Log("Player attacking...");
        yield return new WaitUntil(() => enemyAtkEnded());
    }

    private IEnumerator EnemyBehaviorTurn()
    {
        Debug.Log("Enemies moving...");

        // 적을 5칸씩 나누어 이동시키기
        yield return enemyListManager.MoveEnemies();

        yield return new WaitUntil(() => enemyListManager.AllEnemiesMoved());

        // 이동이 끝나면 스폰 처리
        enemyListManager.SpawnEnemyPerTurn();
    }

    private IEnumerator MoveEnemiesCoroutine()
    {
        var moveEnemiesTask = enemyListManager.MoveEnemies(); // MoveEnemies() 실행
        yield return new WaitUntil(() => moveEnemiesTask.IsCompleted); // 완료될 때까지 대기
    }

    private IEnumerator ChooseBuffTurn()
    {
        Debug.Log("Choosing a buff...");
        buffManager.ShowBuffSelection(); // 버프 선택 UI 표시

        // 버프가 선택될 때까지 대기
        yield return new WaitUntil(() => buffManager.IsBuffSelected());
        updateBuffState();
        Debug.Log("버프 업데이트됨.");
        buffState.printAllStates();
    }

    private IEnumerator EndChkStage()
    {
        Debug.Log("Checking end conditions...");
        damageSum = 0;
        interactionArea.init_ball();
        yield return new WaitUntil(() => chkStageEnded());
    }
 
 */
